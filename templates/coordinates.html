{% extends "base.html" %}

{% block content %}
<article class="post">
    <header class="post-header">
        <h1>{{ page.title }}</h1>
    </header>

    <div class="post-content">
        {{ page.content | safe }}

        <div
            style="margin-top: 2rem; padding: 1.5rem; border: 1px solid var(--accent); border-radius: 8px; background: var(--bg-secondary);">
            <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                <input type="text" id="address-input" placeholder="Enter address..."
                    style="flex-grow: 1; padding: 0.5rem; border: 1px solid var(--text-secondary); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                <button id="get-coords-btn"
                    style="padding: 0.5rem 1rem; background: var(--accent); color: var(--bg-primary); border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Get
                    Coordinates</button>
            </div>

            <div id="result-area" style="margin-top: 1rem; font-family: monospace; min-height: 1.5em;"></div>
            <div id="error-area" style="margin-top: 0.5rem; color: #ff6b6b; display: none;"></div>
        </div>
    </div>
</article>

<script>
    document.getElementById('get-coords-btn').addEventListener('click', async () => {
        const address = document.getElementById('address-input').value.trim();
        const resultArea = document.getElementById('result-area');
        const errorArea = document.getElementById('error-area');

        if (!address) return;

        resultArea.textContent = 'Loading...';
        errorArea.style.display = 'none';

        // Helper to format and display coordinates
        const displayCoords = (lat, lon) => {
            const formatCoord = (val, pos, neg) => {
                const dir = val >= 0 ? pos : neg;
                return `${Math.abs(val).toFixed(6)}Â° ${dir}`;
            };

            const latStr = formatCoord(lat, 'N', 'S');
            const lonStr = formatCoord(lon, 'E', 'W');
            const coords = `${latStr}, ${lonStr}`;

            resultArea.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>${coords}</span>
                    <button onclick="navigator.clipboard.writeText('${coords}')" style="padding: 2px 6px; font-size: 0.8em; cursor: pointer;">Copy</button>
                </div>
            `;
        };

        // Check if input is a Google Maps URL (long or short)
        const googleMapsRegex = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
        const shortLinkRegex = /https:\/\/(maps\.app\.goo\.gl|goo\.gl\/maps)\/[a-zA-Z0-9]+/;

        if (shortLinkRegex.test(address)) {
            try {
                resultArea.textContent = 'Resolving short link...';
                const response = await fetch(`https://unshorten.me/json/${address}`);
                const data = await response.json();

                if (data.success && data.resolved_url) {
                    const resolvedUrl = data.resolved_url;
                    // Try to find coordinates in the resolved URL
                    // It could be in @lat,lon or q=lat,lon or ll=lat,lon

                    // Check for @lat,lon
                    const match = resolvedUrl.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (match) {
                        displayCoords(parseFloat(match[1]), parseFloat(match[2]));
                        return;
                    }

                    // Check for q=lat,lon (URL decoded)
                    const decodedUrl = decodeURIComponent(resolvedUrl);
                    const qMatch = decodedUrl.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (qMatch) {
                        displayCoords(parseFloat(qMatch[1]), parseFloat(qMatch[2]));
                        return;
                    }

                    // Check for ll=lat,lon
                    const llMatch = decodedUrl.match(/[?&]ll=(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (llMatch) {
                        displayCoords(parseFloat(llMatch[1]), parseFloat(llMatch[2]));
                        return;
                    }

                    throw new Error('Could not extract coordinates from resolved URL.');
                } else {
                    throw new Error('Could not resolve short link.');
                }
            } catch (e) {
                resultArea.textContent = '';
                errorArea.textContent = 'Error resolving short link: ' + e.message;
                errorArea.style.display = 'block';
                console.error(e);
                return;
            }
        }

        const match = address.match(googleMapsRegex);

        if (match) {
            const lat = parseFloat(match[1]);
            const lon = parseFloat(match[2]);
            displayCoords(lat, lon);
            return;
        }

        // If not a URL with coordinates, try Geocoding API
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
            const data = await response.json();

            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                displayCoords(lat, lon);
            } else {
                resultArea.textContent = '';
                errorArea.textContent = 'Address not found.';
                errorArea.style.display = 'block';
            }
        } catch (e) {
            resultArea.textContent = '';
            errorArea.textContent = 'Error fetching coordinates.';
            errorArea.style.display = 'block';
            console.error(e);
        }
    });

    document.getElementById('address-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('get-coords-btn').click();
        }
    });
</script>
{% endblock %}