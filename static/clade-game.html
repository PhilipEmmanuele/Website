<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Closest Common Clade</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080b0a;
  --surface: #111916;
  --surface2: #182420;
  --surface3: #1f2e28;
  --border: #283b33;
  --text: #e4ece7;
  --text-dim: #7d9488;
  --text-faint: #4a6358;
  --accent: #4ade80;
  --accent-dim: #1a5c35;
  --warm: #fbbf24;
  --warm-dim: #6b4106;
  --red: #f87171;
  --red-dim: #5c1a1a;
  --blue: #38bdf8;
  --blue-dim: #0c4a6e;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
}

/* â•â•â• MODE SELECT â•â•â• */
.mode-screen {
  max-width: 560px;
  margin: 0 auto;
  padding: 3rem 1.5rem;
  text-align: center;
}

.mode-screen h1 {
  font-family: 'Playfair Display', serif;
  font-weight: 900;
  font-size: 2.3rem;
  letter-spacing: -0.03em;
  background: linear-gradient(135deg, var(--accent), #86efac, var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 0.5rem;
}

.mode-screen .tagline {
  color: var(--text-dim);
  font-size: 0.92rem;
  margin-bottom: 2.5rem;
  line-height: 1.5;
}

.mode-cards { display: flex; flex-direction: column; gap: 0.9rem; }

.mode-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  padding: 1.3rem 1.4rem;
  text-align: left;
  cursor: pointer;
  transition: all 0.25s;
  display: flex;
  align-items: flex-start;
  gap: 1.1rem;
  position: relative;
  overflow: hidden;
}

.mode-card::before {
  content: '';
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity 0.25s;
  pointer-events: none;
}

.mode-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(74,222,128,0.07);
}

.mode-card:hover::before { opacity: 1; }
.mode-card.easy::before { background: radial-gradient(ellipse at top left, rgba(74,222,128,0.06), transparent 60%); }
.mode-card.medium::before { background: radial-gradient(ellipse at top left, rgba(251,191,36,0.06), transparent 60%); }
.mode-card.expert::before { background: radial-gradient(ellipse at top left, rgba(248,113,113,0.06), transparent 60%); }

.mode-icon { font-size: 1.8rem; flex-shrink: 0; margin-top: 0.15rem; }

.mode-info h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.2rem; }

.mode-diff {
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  display: inline-block;
  padding: 0.12rem 0.45rem;
  border-radius: 4px;
  margin-bottom: 0.35rem;
}

.mode-card.easy .mode-diff { background: var(--accent-dim); color: var(--accent); }
.mode-card.medium .mode-diff { background: var(--warm-dim); color: var(--warm); }
.mode-card.expert .mode-diff { background: var(--red-dim); color: var(--red); }

.mode-info p { color: var(--text-dim); font-size: 0.83rem; line-height: 1.5; }

/* â•â•â• GAME SCREEN â•â•â• */
.game-screen {
  display: none;
  max-width: 680px;
  margin: 0 auto;
  padding: 1.5rem 1.5rem 4rem;
}

.game-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.4rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.game-title {
  font-family: 'Playfair Display', serif;
  font-weight: 900;
  font-size: 1.15rem;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.mode-badge {
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 0.18rem 0.55rem;
  border-radius: 4px;
  cursor: pointer;
  transition: opacity 0.2s;
  margin-left: 0.6rem;
}

.mode-badge:hover { opacity: 0.8; }
.mode-badge.easy { background: var(--accent-dim); color: var(--accent); }
.mode-badge.medium { background: var(--warm-dim); color: var(--warm); }
.mode-badge.expert { background: var(--red-dim); color: var(--red); }

.score-bar {
  display: flex;
  gap: 1.2rem;
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  color: var(--text-dim);
}

.score-bar .val { color: var(--accent); font-weight: 500; }

/* Species cards */
.matchup {
  display: flex;
  align-items: center;
  gap: 0.7rem;
  margin-bottom: 1.4rem;
}

.species-card {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem 0.7rem;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.species-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at top, rgba(74,222,128,0.03), transparent 70%);
  pointer-events: none;
}

.species-emoji { font-size: 2.2rem; display: block; margin-bottom: 0.25rem; }
.species-name { font-weight: 700; font-size: 0.92rem; }
.species-taxon {
  font-family: 'DM Mono', monospace;
  font-size: 0.66rem;
  color: var(--text-dim);
  margin-top: 0.12rem;
  font-style: italic;
}

.vs-badge {
  font-family: 'Playfair Display', serif;
  font-weight: 700;
  font-size: 0.78rem;
  color: var(--text-faint);
  flex-shrink: 0;
}

/* â•â•â• GUESS AREA â•â•â• */
.guess-area { margin-bottom: 1rem; }

.guess-label {
  font-size: 0.76rem;
  color: var(--text-dim);
  margin-bottom: 0.4rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.guess-input-wrap { position: relative; }

.guess-input {
  width: 100%;
  padding: 0.75rem 1rem;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.92rem;
  outline: none;
  transition: border-color 0.2s;
}

.guess-input:focus { border-color: var(--accent); }
.guess-input::placeholder { color: var(--text-faint); }
.guess-input:disabled { opacity: 0.5; }

.autocomplete {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  max-height: 190px;
  overflow-y: auto;
  z-index: 100;
  display: none;
}

.autocomplete.show { display: block; }

.ac-item {
  padding: 0.5rem 1rem;
  cursor: pointer;
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: background 0.12s;
}

.ac-item:hover, .ac-item.active { background: rgba(74,222,128,0.08); }
.ac-item .ac-name { font-weight: 500; }
.ac-item .ac-desc {
  font-size: 0.7rem;
  color: var(--text-dim);
  margin-left: auto;
  font-family: 'DM Mono', monospace;
}

.no-match-msg {
  color: var(--red);
  font-size: 0.8rem;
  margin-top: 0.35rem;
  display: none;
}

.no-match-msg.show { display: block; }

/* Buttons */
.btn-row { display: flex; gap: 0.6rem; margin-bottom: 1.2rem; }

.btn {
  flex: 1;
  padding: 0.7rem 1rem;
  border: none;
  border-radius: 10px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.86rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary { background: var(--accent); color: var(--bg); }
.btn-primary:hover { background: #5ee98f; transform: translateY(-1px); }
.btn-primary:disabled { background: var(--accent-dim); color: var(--text-faint); cursor: not-allowed; transform: none; }

.btn-secondary { background: var(--surface); color: var(--text-dim); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--text-dim); color: var(--text); }

/* Feedback */
.feedback {
  border-radius: 10px;
  padding: 0.85rem 1rem;
  margin-bottom: 1rem;
  font-size: 0.86rem;
  line-height: 1.5;
  display: none;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}

.feedback.show { display: block; }
.feedback.wrong { background: var(--red-dim); border: 1px solid #7f1d1d; color: #fca5a5; }
.feedback.close-guess { background: var(--warm-dim); border: 1px solid #854d0e; color: #fcd34d; }
.feedback.correct { background: rgba(74,222,128,0.1); border: 1px solid var(--accent-dim); color: var(--accent); }

.feedback .fb-title { font-weight: 700; margin-bottom: 0.15rem; }

/* History */
.history { margin-bottom: 1rem; }

.history-title {
  font-size: 0.7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 0.35rem;
  font-weight: 600;
}

.history-list { display: flex; flex-direction: column; gap: 0.25rem; }

.history-item {
  font-family: 'DM Mono', monospace;
  font-size: 0.74rem;
  color: var(--text-dim);
  padding: 0.3rem 0.55rem;
  background: var(--surface);
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

/* â•â•â• REVEAL TREE â•â•â• */
.tree-reveal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.2rem 0.8rem;
  margin-bottom: 1.2rem;
  display: none;
  overflow-x: auto;
}

.tree-reveal.show { display: block; animation: slideIn 0.4s ease; }

.tree-reveal h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1rem;
  margin-bottom: 0.2rem;
  color: var(--accent);
  text-align: center;
}

.tree-subtitle {
  text-align: center;
  font-size: 0.73rem;
  color: var(--text-dim);
  margin-bottom: 0.8rem;
  font-family: 'DM Mono', monospace;
}

.tree-svg-wrap { width: 100%; display: flex; justify-content: center; }
.tree-svg-wrap svg { display: block; max-width: 100%; height: auto; }

.tree-branch {
  stroke-dasharray: 1000;
  stroke-dashoffset: 1000;
  animation: drawBranch 0.6s ease forwards;
}

@keyframes drawBranch { to { stroke-dashoffset: 0; } }

.tree-node-g {
  opacity: 0;
  animation: fadeNode 0.35s ease forwards;
}

@keyframes fadeNode { to { opacity: 1; } }

/* â•â•â• EASY MODE: VERTICAL TREE â•â•â• */
.vtree-wrap {
  margin-bottom: 1.2rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem 0.5rem 1rem 0.8rem;
  max-height: 60vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.vtree-node {
  position: relative;
  padding-left: 1.1rem;
}

.vtree-node .vtree-children {
  border-left: 1.5px solid var(--border);
  margin-left: 0.15rem;
}

.vtree-row {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.25rem 0.6rem;
  margin: 0.15rem 0;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--text);
  background: transparent;
  border: 1.5px solid transparent;
}

.vtree-row::before {
  content: '';
  position: absolute;
  left: -1.1rem;
  top: 50%;
  width: 0.8rem;
  height: 0;
  border-top: 1.5px solid var(--border);
}

.vtree-node:first-child > .vtree-row::before {
  /* still show connector */
}

.vtree-row:hover {
  background: var(--surface2);
  border-color: var(--border);
}

.vtree-row .vtree-desc {
  font-family: 'DM Mono', monospace;
  font-size: 0.66rem;
  color: var(--text-faint);
  font-weight: 400;
}

/* Root node: no connector */
.vtree-wrap > .vtree-node > .vtree-row::before { display: none; }
.vtree-wrap > .vtree-node { padding-left: 0; }

/* Guessed states */
.vtree-row.guessed-correct {
  background: var(--accent-dim) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
}

.vtree-row.guessed-toofar {
  background: var(--warm-dim) !important;
  border-color: #854d0e !important;
  color: var(--warm) !important;
}

.vtree-row.guessed-tooclose {
  background: var(--red-dim) !important;
  border-color: #7f1d1d !important;
  color: var(--red) !important;
}

.vtree-row.guessed-wrong {
  background: #2a1515 !important;
  border-color: #5c1a1a !important;
  color: #e88 !important;
}

.vtree-row.answer-reveal {
  background: var(--accent-dim) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
  box-shadow: 0 0 12px rgba(74,222,128,0.25);
}

.vtree-row.disabled {
  cursor: default;
  pointer-events: none;
}

/* How to play */
.info-panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.9rem 1.1rem;
  margin-bottom: 1.5rem;
}

.info-panel summary {
  cursor: pointer;
  font-weight: 600;
  font-size: 0.8rem;
  color: var(--text-dim);
  list-style: none;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.info-panel summary::before { content: 'â–¸'; transition: transform 0.2s; }
.info-panel[open] summary::before { transform: rotate(90deg); }

.info-panel .info-body {
  margin-top: 0.6rem;
  font-size: 0.8rem;
  color: var(--text-dim);
  line-height: 1.7;
}

@media (max-width: 550px) {
  .mode-screen { padding: 2rem 1rem; }
  .mode-screen h1 { font-size: 1.7rem; }
  .game-screen { padding: 1rem 0.8rem 3rem; }
  .matchup { flex-direction: column; gap: 0.4rem; }
  .species-card { width: 100%; }
  .score-bar { gap: 0.7rem; font-size: 0.7rem; }
}
</style>
</head>
<body>

<!-- â•â•â• MODE SELECT â•â•â• -->
<div class="mode-screen" id="modeScreen">
  <h1>Closest Common Clade</h1>
  <p class="tagline">Two animals. One shared clade. How well do you know the tree of life?</p>
  <div class="mode-cards">
    <div class="mode-card easy" onclick="startGame('easy')">
      <div class="mode-icon">ğŸŒ¿</div>
      <div class="mode-info">
        <span class="mode-diff">Easy</span>
        <h2>Tree Explorer</h2>
        <p>Browse the full tree of life and click where you think the two animals share a clade.</p>
      </div>
    </div>
    <div class="mode-card medium" onclick="startGame('medium')">
      <div class="mode-icon">ğŸ”¬</div>
      <div class="mode-info">
        <span class="mode-diff">Medium</span>
        <h2>Guided Search</h2>
        <p>Type to search with autocomplete suggestions. Directional hints guide you when wrong.</p>
      </div>
    </div>
    <div class="mode-card expert" onclick="startGame('expert')">
      <div class="mode-icon">ğŸ§¬</div>
      <div class="mode-info">
        <span class="mode-diff">Expert</span>
        <h2>From Memory</h2>
        <p>No tree, no suggestions, no hints. Just you and your knowledge of taxonomy.</p>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• GAME SCREEN â•â•â• -->
<div class="game-screen" id="gameScreen">
  <div class="game-header">
    <div>
      <span class="game-title">Closest Common Clade</span>
      <span class="mode-badge" id="modeBadge" onclick="goToModeSelect()"></span>
    </div>
    <div class="score-bar">
      <span>Rd <span class="val" id="round">1</span></span>
      <span>Score <span class="val" id="score">0</span></span>
      <span>Streak <span class="val" id="streak">0</span></span>
    </div>
  </div>

  <div class="matchup">
    <div class="species-card">
      <span class="species-emoji" id="emoji1"></span>
      <div class="species-name" id="name1"></div>
      <div class="species-taxon" id="taxon1"></div>
    </div>
    <div class="vs-badge">vs</div>
    <div class="species-card">
      <span class="species-emoji" id="emoji2"></span>
      <div class="species-name" id="name2"></div>
      <div class="species-taxon" id="taxon2"></div>
    </div>
  </div>

  <div id="guessAreaWrap"></div>

  <div class="feedback" id="feedback">
    <div class="fb-title" id="fbTitle"></div>
    <div id="fbText"></div>
  </div>

  <div class="history" id="historyWrap" style="display:none">
    <div class="history-title">Your guesses</div>
    <div class="history-list" id="historyList"></div>
  </div>

  <div class="tree-reveal" id="treeReveal">
    <h3>Shared Taxonomy</h3>
    <div class="tree-subtitle" id="treeSubtitle"></div>
    <div class="tree-svg-wrap" id="treeSvgWrap"></div>
  </div>

  <div class="btn-row" id="nextRow" style="display:none">
    <button class="btn btn-primary" id="nextBtn" onclick="nextRound()">Next Round â†’</button>
  </div>

  <details class="info-panel">
    <summary>How to play</summary>
    <div class="info-body" id="howToPlayText"></div>
  </details>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ANCESTORS = {
  "Metazoa":         { parent: null,             depth: 0,  desc: "All animals" },
  "Bilateria":       { parent: "Metazoa",        depth: 1,  desc: "Bilaterally symmetric animals" },
  "Cnidaria":        { parent: "Metazoa",        depth: 1,  desc: "Jellyfish, corals, anemones" },
  "Deuterostomia":   { parent: "Bilateria",      depth: 2,  desc: "Deuterostomes" },
  "Protostomia":     { parent: "Bilateria",      depth: 2,  desc: "Protostomes" },
  "Chordata":        { parent: "Deuterostomia",  depth: 3,  desc: "Animals with notochords" },
  "Echinodermata":   { parent: "Deuterostomia",  depth: 3,  desc: "Starfish, sea urchins" },
  "Arthropoda":      { parent: "Protostomia",    depth: 3,  desc: "Insects, spiders, crabs" },
  "Mollusca":        { parent: "Protostomia",    depth: 3,  desc: "Snails, octopuses, clams" },
  "Annelida":        { parent: "Protostomia",    depth: 3,  desc: "Segmented worms" },
  "Vertebrata":      { parent: "Chordata",       depth: 4,  desc: "Animals with backbones" },
  "Gnathostomata":   { parent: "Vertebrata",     depth: 5,  desc: "Jawed vertebrates" },
  "Osteichthyes":    { parent: "Gnathostomata",  depth: 6,  desc: "Bony fish & descendants" },
  "Chondrichthyes":  { parent: "Gnathostomata",  depth: 6,  desc: "Sharks & rays" },
  "Tetrapoda":       { parent: "Osteichthyes",   depth: 7,  desc: "Four-limbed vertebrates" },
  "Actinopterygii":  { parent: "Osteichthyes",   depth: 7,  desc: "Ray-finned fishes" },
  "Amniota":         { parent: "Tetrapoda",      depth: 8,  desc: "Land egg-layers & descendants" },
  "Amphibia":        { parent: "Tetrapoda",      depth: 8,  desc: "Frogs, salamanders" },
  "Mammalia":        { parent: "Amniota",        depth: 9,  desc: "Mammals" },
  "Reptilia":        { parent: "Amniota",        depth: 9,  desc: "Reptiles & birds" },
  "Theria":          { parent: "Mammalia",       depth: 10, desc: "Marsupials & placentals" },
  "Monotremata":     { parent: "Mammalia",       depth: 10, desc: "Egg-laying mammals" },
  "Placentalia":     { parent: "Theria",         depth: 11, desc: "Placental mammals" },
  "Marsupialia":     { parent: "Theria",         depth: 11, desc: "Marsupials" },
  "Archosauria":     { parent: "Reptilia",       depth: 10, desc: "Birds & crocodilians" },
  "Lepidosauria":    { parent: "Reptilia",       depth: 10, desc: "Lizards & snakes" },
  "Testudines":      { parent: "Reptilia",       depth: 10, desc: "Turtles & tortoises" },
  "Aves":            { parent: "Archosauria",    depth: 11, desc: "Birds" },
  "Crocodilia":      { parent: "Archosauria",    depth: 11, desc: "Crocodilians" },
  "Afrotheria":      { parent: "Placentalia",    depth: 12, desc: "Elephants, manatees, etc." },
  "Boreoeutheria":   { parent: "Placentalia",    depth: 12, desc: "Most N. hemisphere mammals" },
  "Xenarthra":       { parent: "Placentalia",    depth: 12, desc: "Sloths, armadillos" },
  "Laurasiatheria":  { parent: "Boreoeutheria",  depth: 13, desc: "Bats, whales, cats, horses..." },
  "Euarchontoglires":{ parent: "Boreoeutheria",  depth: 13, desc: "Primates, rodents, rabbits" },
  "Glires":          { parent: "Euarchontoglires", depth: 14, desc: "Rodents & lagomorphs" },
  "Carnivora":       { parent: "Laurasiatheria", depth: 14, desc: "Cats, dogs, bears, seals" },
  "Perissodactyla":  { parent: "Laurasiatheria", depth: 14, desc: "Horses, rhinos, tapirs" },
  "Artiodactyla":    { parent: "Laurasiatheria", depth: 14, desc: "Even-toed ungulates & whales" },
  "Chiroptera":      { parent: "Laurasiatheria", depth: 14, desc: "Bats" },
  "Primates":        { parent: "Euarchontoglires", depth: 14, desc: "Primates" },
  "Rodentia":        { parent: "Glires",          depth: 15, desc: "Rodents" },
  "Lagomorpha":      { parent: "Glires",          depth: 15, desc: "Rabbits & hares" },
  "Hominidae":       { parent: "Primates",       depth: 15, desc: "Great apes" },
  "Cercopithecidae": { parent: "Primates",       depth: 15, desc: "Old World monkeys" },
  "Felidae":         { parent: "Carnivora",      depth: 15, desc: "Cat family" },
  "Canidae":         { parent: "Carnivora",      depth: 15, desc: "Dog family" },
  "Ursidae":         { parent: "Carnivora",      depth: 15, desc: "Bear family" },
  "Bovidae":         { parent: "Artiodactyla",   depth: 15, desc: "Cattle, goats, sheep" },
  "Cervidae":        { parent: "Artiodactyla",   depth: 15, desc: "Deer family" },
  "Cetacea":         { parent: "Artiodactyla",   depth: 15, desc: "Whales & dolphins" },
  "Suidae":          { parent: "Artiodactyla",   depth: 15, desc: "Pig family" },
  "Insecta":         { parent: "Arthropoda",     depth: 4,  desc: "Insects" },
  "Arachnida":       { parent: "Arthropoda",     depth: 4,  desc: "Spiders, scorpions, ticks" },
  "Crustacea":       { parent: "Arthropoda",     depth: 4,  desc: "Crabs, lobsters, shrimp" },
  "Cephalopoda":     { parent: "Mollusca",       depth: 4,  desc: "Octopuses, squid" },
  "Gastropoda":      { parent: "Mollusca",       depth: 4,  desc: "Snails & slugs" },
  "Bivalvia":        { parent: "Mollusca",       depth: 4,  desc: "Clams, mussels, oysters" },
  "Hymenoptera":     { parent: "Insecta",        depth: 5,  desc: "Ants, bees, wasps" },
  "Lepidoptera":     { parent: "Insecta",        depth: 5,  desc: "Butterflies & moths" },
  "Coleoptera":      { parent: "Insecta",        depth: 5,  desc: "Beetles" },
  "Diptera":         { parent: "Insecta",        depth: 5,  desc: "Flies & mosquitoes" },
};

const ALIASES = {};
Object.keys(ANCESTORS).forEach(k => { ALIASES[k.toLowerCase()] = k; });

const EXTRA_ALIASES = {
  "animals":"Metazoa","animal":"Metazoa","metazoans":"Metazoa",
  "bilateral":"Bilateria","bilaterians":"Bilateria",
  "jellyfish":"Cnidaria","corals":"Cnidaria","cnidarians":"Cnidaria",
  "deuterostomes":"Deuterostomia","protostomes":"Protostomia",
  "chordates":"Chordata",
  "starfish":"Echinodermata","sea urchins":"Echinodermata","echinoderms":"Echinodermata",
  "arthropods":"Arthropoda","bugs":"Arthropoda",
  "mollusks":"Mollusca","molluscs":"Mollusca",
  "worms":"Annelida","segmented worms":"Annelida","annelids":"Annelida",
  "vertebrates":"Vertebrata",
  "jawed vertebrates":"Gnathostomata","jawed fish":"Gnathostomata",
  "bony fish":"Osteichthyes","bony fishes":"Osteichthyes",
  "sharks":"Chondrichthyes","rays":"Chondrichthyes","cartilaginous fish":"Chondrichthyes",
  "tetrapods":"Tetrapoda",
  "ray-finned fish":"Actinopterygii","ray-finned fishes":"Actinopterygii","fish":"Actinopterygii",
  "amniotes":"Amniota","amphibians":"Amphibia","frogs":"Amphibia",
  "mammals":"Mammalia","reptiles":"Reptilia",
  "therians":"Theria","monotremes":"Monotremata","egg-laying mammals":"Monotremata",
  "placental mammals":"Placentalia","placentals":"Placentalia",
  "marsupials":"Marsupialia","archosaurs":"Archosauria",
  "lizards":"Lepidosauria","snakes":"Lepidosauria",
  "turtles":"Testudines","tortoises":"Testudines",
  "birds":"Aves","crocodilians":"Crocodilia","crocodiles":"Crocodilia","alligators":"Crocodilia",
  "elephants":"Afrotheria","sloths":"Xenarthra","armadillos":"Xenarthra",
  "carnivores":"Carnivora",
  "odd-toed ungulates":"Perissodactyla","horses":"Perissodactyla",
  "even-toed ungulates":"Artiodactyla","ungulates":"Artiodactyla",
  "bats":"Chiroptera","primates":"Primates","monkeys":"Primates",
  "rodents":"Rodentia","rodents and rabbits":"Glires","glires":"Glires","rabbits":"Lagomorpha","hares":"Lagomorpha",
  "great apes":"Hominidae","apes":"Hominidae",
  "old world monkeys":"Cercopithecidae",
  "cats":"Felidae","felines":"Felidae",
  "dogs":"Canidae","canines":"Canidae","wolves":"Canidae",
  "bears":"Ursidae",
  "cattle":"Bovidae","cows":"Bovidae","goats":"Bovidae","sheep":"Bovidae","bovids":"Bovidae",
  "deer":"Cervidae","whales":"Cetacea","dolphins":"Cetacea","cetaceans":"Cetacea",
  "pigs":"Suidae",
  "insects":"Insecta","spiders":"Arachnida","scorpions":"Arachnida","arachnids":"Arachnida",
  "crabs":"Crustacea","lobsters":"Crustacea","shrimp":"Crustacea","crustaceans":"Crustacea",
  "octopuses":"Cephalopoda","squid":"Cephalopoda","cephalopods":"Cephalopoda",
  "snails":"Gastropoda","slugs":"Gastropoda","gastropods":"Gastropoda",
  "clams":"Bivalvia","mussels":"Bivalvia","oysters":"Bivalvia","bivalves":"Bivalvia",
  "ants":"Hymenoptera","bees":"Hymenoptera","wasps":"Hymenoptera",
  "butterflies":"Lepidoptera","moths":"Lepidoptera",
  "beetles":"Coleoptera","flies":"Diptera","mosquitoes":"Diptera",
};
Object.entries(EXTRA_ALIASES).forEach(([k,v]) => { ALIASES[k.toLowerCase()] = v; });

const SPECIES = [
  { name:"Human",emoji:"ğŸ§‘",taxon:"Homo sapiens",clade:"Hominidae" },
  { name:"Chimpanzee",emoji:"ğŸ¦§",taxon:"Pan troglodytes",clade:"Hominidae" },
  { name:"Gorilla",emoji:"ğŸ¦",taxon:"Gorilla gorilla",clade:"Hominidae" },
  { name:"Baboon",emoji:"ğŸ’",taxon:"Papio hamadryas",clade:"Cercopithecidae" },
  { name:"House Cat",emoji:"ğŸ±",taxon:"Felis catus",clade:"Felidae" },
  { name:"Lion",emoji:"ğŸ¦",taxon:"Panthera leo",clade:"Felidae" },
  { name:"Tiger",emoji:"ğŸ¯",taxon:"Panthera tigris",clade:"Felidae" },
  { name:"Dog",emoji:"ğŸ•",taxon:"Canis familiaris",clade:"Canidae" },
  { name:"Wolf",emoji:"ğŸº",taxon:"Canis lupus",clade:"Canidae" },
  { name:"Fox",emoji:"ğŸ¦Š",taxon:"Vulpes vulpes",clade:"Canidae" },
  { name:"Grizzly Bear",emoji:"ğŸ»",taxon:"Ursus arctos",clade:"Ursidae" },
  { name:"Polar Bear",emoji:"ğŸ»â€â„ï¸",taxon:"Ursus maritimus",clade:"Ursidae" },
  { name:"Horse",emoji:"ğŸ´",taxon:"Equus caballus",clade:"Perissodactyla" },
  { name:"Rhinoceros",emoji:"ğŸ¦",taxon:"Ceratotherium simum",clade:"Perissodactyla" },
  { name:"Cow",emoji:"ğŸ„",taxon:"Bos taurus",clade:"Bovidae" },
  { name:"Goat",emoji:"ğŸ",taxon:"Capra aegagrus",clade:"Bovidae" },
  { name:"Sheep",emoji:"ğŸ‘",taxon:"Ovis aries",clade:"Bovidae" },
  { name:"Deer",emoji:"ğŸ¦Œ",taxon:"Cervus elaphus",clade:"Cervidae" },
  { name:"Pig",emoji:"ğŸ–",taxon:"Sus scrofa",clade:"Suidae" },
  { name:"Dolphin",emoji:"ğŸ¬",taxon:"Tursiops truncatus",clade:"Cetacea" },
  { name:"Blue Whale",emoji:"ğŸ‹",taxon:"Balaenoptera musculus",clade:"Cetacea" },
  { name:"Bat",emoji:"ğŸ¦‡",taxon:"Chiroptera sp.",clade:"Chiroptera" },
  { name:"Elephant",emoji:"ğŸ˜",taxon:"Loxodonta africana",clade:"Afrotheria" },
  { name:"Mouse",emoji:"ğŸ­",taxon:"Mus musculus",clade:"Rodentia" },
  { name:"Rat",emoji:"ğŸ€",taxon:"Rattus norvegicus",clade:"Rodentia" },
  { name:"Beaver",emoji:"ğŸ¦«",taxon:"Castor canadensis",clade:"Rodentia" },
  { name:"Rabbit",emoji:"ğŸ‡",taxon:"Oryctolagus cuniculus",clade:"Lagomorpha" },
  { name:"Kangaroo",emoji:"ğŸ¦˜",taxon:"Macropus rufus",clade:"Marsupialia" },
  { name:"Koala",emoji:"ğŸ¨",taxon:"Phascolarctos cinereus",clade:"Marsupialia" },
  { name:"Platypus",emoji:"ğŸ¦†",taxon:"Ornithorhynchus anatinus",clade:"Monotremata" },
  { name:"Sloth",emoji:"ğŸ¦¥",taxon:"Bradypus variegatus",clade:"Xenarthra" },
  { name:"Chicken",emoji:"ğŸ”",taxon:"Gallus gallus",clade:"Aves" },
  { name:"Eagle",emoji:"ğŸ¦…",taxon:"Aquila chrysaetos",clade:"Aves" },
  { name:"Penguin",emoji:"ğŸ§",taxon:"Aptenodytes forsteri",clade:"Aves" },
  { name:"Parrot",emoji:"ğŸ¦œ",taxon:"Psittacus erithacus",clade:"Aves" },
  { name:"Owl",emoji:"ğŸ¦‰",taxon:"Bubo bubo",clade:"Aves" },
  { name:"Crocodile",emoji:"ğŸŠ",taxon:"Crocodylus niloticus",clade:"Crocodilia" },
  { name:"Komodo Dragon",emoji:"ğŸ¦",taxon:"Varanus komodoensis",clade:"Lepidosauria" },
  { name:"Snake",emoji:"ğŸ",taxon:"Serpentes sp.",clade:"Lepidosauria" },
  { name:"Gecko",emoji:"ğŸ¦",taxon:"Gekko gecko",clade:"Lepidosauria" },
  { name:"Sea Turtle",emoji:"ğŸ¢",taxon:"Chelonia mydas",clade:"Testudines" },
  { name:"Tortoise",emoji:"ğŸ¢",taxon:"Testudo graeca",clade:"Testudines" },
  { name:"Frog",emoji:"ğŸ¸",taxon:"Rana temporaria",clade:"Amphibia" },
  { name:"Salamander",emoji:"ğŸ¦",taxon:"Salamandra salamandra",clade:"Amphibia" },
  { name:"Salmon",emoji:"ğŸŸ",taxon:"Salmo salar",clade:"Actinopterygii" },
  { name:"Clownfish",emoji:"ğŸ ",taxon:"Amphiprion ocellaris",clade:"Actinopterygii" },
  { name:"Tuna",emoji:"ğŸŸ",taxon:"Thunnus thynnus",clade:"Actinopterygii" },
  { name:"Great White Shark",emoji:"ğŸ¦ˆ",taxon:"Carcharodon carcharias",clade:"Chondrichthyes" },
  { name:"Manta Ray",emoji:"ğŸ¦ˆ",taxon:"Mobula birostris",clade:"Chondrichthyes" },
  { name:"Starfish",emoji:"â­",taxon:"Asterias rubens",clade:"Echinodermata" },
  { name:"Sea Urchin",emoji:"ğŸŸ¤",taxon:"Paracentrotus lividus",clade:"Echinodermata" },
  { name:"Octopus",emoji:"ğŸ™",taxon:"Octopus vulgaris",clade:"Cephalopoda" },
  { name:"Squid",emoji:"ğŸ¦‘",taxon:"Loligo vulgaris",clade:"Cephalopoda" },
  { name:"Garden Snail",emoji:"ğŸŒ",taxon:"Cornu aspersum",clade:"Gastropoda" },
  { name:"Clam",emoji:"ğŸš",taxon:"Mercenaria mercenaria",clade:"Bivalvia" },
  { name:"Oyster",emoji:"ğŸ¦ª",taxon:"Crassostrea gigas",clade:"Bivalvia" },
  { name:"Earthworm",emoji:"ğŸª±",taxon:"Lumbricus terrestris",clade:"Annelida" },
  { name:"Honeybee",emoji:"ğŸ",taxon:"Apis mellifera",clade:"Hymenoptera" },
  { name:"Ant",emoji:"ğŸœ",taxon:"Formicidae sp.",clade:"Hymenoptera" },
  { name:"Butterfly",emoji:"ğŸ¦‹",taxon:"Vanessa cardui",clade:"Lepidoptera" },
  { name:"Ladybug",emoji:"ğŸ",taxon:"Coccinella septempunctata",clade:"Coleoptera" },
  { name:"Housefly",emoji:"ğŸª°",taxon:"Musca domestica",clade:"Diptera" },
  { name:"Mosquito",emoji:"ğŸ¦Ÿ",taxon:"Aedes aegypti",clade:"Diptera" },
  { name:"Spider",emoji:"ğŸ•·ï¸",taxon:"Araneae sp.",clade:"Arachnida" },
  { name:"Scorpion",emoji:"ğŸ¦‚",taxon:"Scorpiones sp.",clade:"Arachnida" },
  { name:"Lobster",emoji:"ğŸ¦",taxon:"Homarus americanus",clade:"Crustacea" },
  { name:"Crab",emoji:"ğŸ¦€",taxon:"Cancer pagurus",clade:"Crustacea" },
  { name:"Jellyfish",emoji:"ğŸª¼",taxon:"Aurelia aurita",clade:"Cnidaria" },
  { name:"Coral",emoji:"ğŸª¸",taxon:"Acropora millepora",clade:"Cnidaria" },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TREE LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getAncestorChain(key) {
  const chain = [key];
  let cur = key;
  while (ANCESTORS[cur]?.parent) { cur = ANCESTORS[cur].parent; chain.push(cur); }
  return chain;
}

function findLCA(sp1, sp2) {
  const chain1 = getAncestorChain(sp1.clade);
  const set2 = new Set(getAncestorChain(sp2.clade));
  for (const n of chain1) { if (set2.has(n)) return n; }
  return "Metazoa";
}

function evaluateGuess(guessKey, correctLCA, sp1, sp2) {
  if (guessKey === correctLCA) return { result: "correct" };
  if (getAncestorChain(correctLCA).includes(guessKey)) return { result: "too_far_back" };
  const on1 = getAncestorChain(sp1.clade).includes(guessKey);
  const on2 = getAncestorChain(sp2.clade).includes(guessKey);
  if (on1 && !on2) return { result: "too_close", toward: sp1.name };
  if (on2 && !on1) return { result: "too_close", toward: sp2.name };
  return { result: "wrong" };
}

function getChildrenOf(key) {
  return Object.keys(ANCESTORS).filter(k => ANCESTORS[k].parent === key);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE & FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TEMPERATURES = { easy: 0.8, medium: 1.5, expert: 1.5 };

// Precompute all valid pairs with phylogenetic distances
let ALL_PAIRS = null;

function precomputePairs() {
  if (ALL_PAIRS) return;
  ALL_PAIRS = [];
  for (let i = 0; i < SPECIES.length; i++) {
    for (let j = i + 1; j < SPECIES.length; j++) {
      const s1 = SPECIES[i], s2 = SPECIES[j];
      if (s1.clade === s2.clade) continue; // skip same-family
      const lca = findLCA(s1, s2);
      const d1 = ANCESTORS[s1.clade].depth - ANCESTORS[lca].depth;
      const d2 = ANCESTORS[s2.clade].depth - ANCESTORS[lca].depth;
      const dist = d1 + d2;
      ALL_PAIRS.push({ i, j, lca, dist });
    }
  }
}

function pickPair() {
  precomputePairs();
  const temp = TEMPERATURES[state.mode] || 1.5;

  // Filter out used pairs
  let available = ALL_PAIRS.filter(p => {
    const pk = [SPECIES[p.i].name, SPECIES[p.j].name].sort().join("|");
    return !state.usedPairs.has(pk);
  });

  // Reset if exhausted
  if (available.length === 0) {
    state.usedPairs.clear();
    available = ALL_PAIRS;
  }

  // Compute softmax weights: weight = exp(-distance / temperature)
  // Use negative distance so closer pairs get higher weight
  const logits = available.map(p => -p.dist / temp);
  const maxLogit = Math.max(...logits);
  const expWeights = logits.map(l => Math.exp(l - maxLogit)); // subtract max for numerical stability
  const sumWeights = expWeights.reduce((a, b) => a + b, 0);

  // Weighted random sample
  let r = Math.random() * sumWeights;
  let chosen = available[available.length - 1];
  for (let k = 0; k < available.length; k++) {
    r -= expWeights[k];
    if (r <= 0) { chosen = available[k]; break; }
  }

  const sp1 = SPECIES[chosen.i], sp2 = SPECIES[chosen.j];
  const pk = [sp1.name, sp2.name].sort().join("|");
  state.usedPairs.add(pk);

  return { sp1, sp2, lca: chosen.lca };
}

let state = { mode:null, round:1, score:0, streak:0, sp1:null, sp2:null, correctLCA:null, guesses:[], maxGuesses:4, resolved:false, usedPairs:new Set() };
let selectedGuess = null;

function startGame(mode) {
  state.mode = mode;
  state.round = 1; state.score = 0; state.streak = 0;
  state.usedPairs.clear();

  document.getElementById("modeScreen").style.display = "none";
  const gs = document.getElementById("gameScreen");
  gs.style.display = "block";

  const badge = document.getElementById("modeBadge");
  badge.textContent = mode==="easy"?"ğŸŒ¿ Easy":mode==="medium"?"ğŸ”¬ Medium":"ğŸ§¬ Expert";
  badge.className = "mode-badge " + mode;

  const h = document.getElementById("howToPlayText");
  if (mode==="easy") h.innerHTML = `See the full <strong>tree of life</strong> and click the clade you think both animals share. Hover for descriptions. Nodes light up with feedback: <strong style="color:var(--accent)">green</strong> = correct, <strong style="color:var(--warm)">gold</strong> = too far back, <strong style="color:var(--red)">red</strong> = too close to one animal or wrong. 3 pts first try, 2 second, 1 third. 4 guesses max.`;
  else if (mode==="medium") h.innerHTML = `Type to search with autocomplete. Name the <strong>closest shared clade</strong>. Hints tell you if you're <strong>too close</strong> to one animal or <strong>too far back</strong> in the tree. 3 pts first try, 2 second, 1 third. 4 guesses max.`;
  else h.innerHTML = `No tree. No suggestions. No directional hints. Type the exact clade name from memory. Both scientific names (Mammalia) and common names (mammals) work. You only learn if you're <strong>right or wrong</strong>. 3 pts first try, 2 second, 1 third. 4 guesses max.`;

  startRound();
}

function goToModeSelect() {
  document.getElementById("gameScreen").style.display = "none";
  document.getElementById("modeScreen").style.display = "block";
}

function startRound() {
  const { sp1, sp2, lca } = pickPair();
  state.sp1=sp1; state.sp2=sp2; state.correctLCA=lca;
  state.guesses=[]; state.resolved=false;

  document.getElementById("emoji1").textContent=sp1.emoji;
  document.getElementById("name1").textContent=sp1.name;
  document.getElementById("taxon1").textContent=sp1.taxon;
  document.getElementById("emoji2").textContent=sp2.emoji;
  document.getElementById("name2").textContent=sp2.name;
  document.getElementById("taxon2").textContent=sp2.taxon;

  updateScores();
  document.getElementById("feedback").className="feedback";
  document.getElementById("historyWrap").style.display="none";
  document.getElementById("historyList").innerHTML="";
  document.getElementById("treeReveal").className="tree-reveal";
  document.getElementById("nextRow").style.display="none";

  renderGuessArea();
}

function updateScores() {
  document.getElementById("round").textContent=state.round;
  document.getElementById("score").textContent=state.score;
  document.getElementById("streak").textContent=state.streak;
}

function nextRound() { state.round++; startRound(); }

function submitGuess(guessKey) {
  if (state.resolved) return;
  const result = evaluateGuess(guessKey, state.correctLCA, state.sp1, state.sp2);
  state.guesses.push({ key:guessKey, result });

  const fb=document.getElementById("feedback");
  const fbTitle=document.getElementById("fbTitle");
  const fbText=document.getElementById("fbText");
  const desc = ANCESTORS[guessKey]?.desc || "";

  const histWrap=document.getElementById("historyWrap");
  const histList=document.getElementById("historyList");
  histWrap.style.display="block";

  const hi = document.createElement("div");
  hi.className = "history-item";

  const isExpert = state.mode === "expert";

  if (result.result === "correct") {
    fb.className = "feedback correct show";
    fbTitle.textContent = "ğŸ¯ Correct!";
    const pts = state.guesses.length===1?3:state.guesses.length===2?2:1;
    state.score += pts; state.streak++;
    fbText.textContent = `${guessKey} â€” ${desc}. +${pts} point${pts>1?'s':''}!`;
    hi.innerHTML = `<span>âœ…</span> ${guessKey} â€” Correct!`;
    endRound();
  } else if (isExpert) {
    // Expert: binary feedback only
    fb.className = "feedback wrong show";
    fbTitle.textContent = "âŒ Wrong";
    fbText.textContent = `${guessKey} is not the closest shared clade.`;
    hi.innerHTML = `<span>âŒ</span> ${guessKey}`;
  } else if (result.result === "too_far_back") {
    fb.className = "feedback close-guess show";
    fbTitle.textContent = "ğŸ”µ Too far back!";
    fbText.textContent = `${guessKey} (${desc}) includes both animals, but their closest shared clade is more specific.`;
    hi.innerHTML = `<span>ğŸ”µ</span> ${guessKey} â€” Too far back`;
  } else if (result.result === "too_close") {
    fb.className = "feedback wrong show";
    fbTitle.textContent = `ğŸ”¶ Too close to ${result.toward}!`;
    fbText.textContent = `${guessKey} (${desc}) only covers the ${result.toward} side. You need a clade that includes both.`;
    hi.innerHTML = `<span>ğŸ”¶</span> ${guessKey} â€” Too close to ${result.toward}`;
  } else {
    fb.className = "feedback wrong show";
    fbTitle.textContent = "âŒ Not quite!";
    fbText.textContent = `${guessKey} (${desc}) doesn't correctly describe the relationship.`;
    hi.innerHTML = `<span>âŒ</span> ${guessKey} â€” Wrong`;
  }

  histList.appendChild(hi);

  // Color easy-mode tree node
  if (state.mode === "easy") {
    const row = document.querySelector(`.vtree-row[data-key="${guessKey}"]`);
    if (row) {
      const cls = result.result==="correct"?"guessed-correct"
        :result.result==="too_far_back"?"guessed-toofar"
        :result.result==="too_close"?"guessed-tooclose"
        :"guessed-wrong";
      row.classList.add(cls);
      row.scrollIntoView({ behavior:"smooth", block:"center" });
    }
  }

  if (result.result !== "correct" && state.guesses.length >= state.maxGuesses) {
    state.streak = 0;
    fb.className = "feedback wrong show";
    fbTitle.textContent = "Out of guesses!";
    fbText.textContent = `The answer was ${state.correctLCA} â€” ${ANCESTORS[state.correctLCA].desc}.`;
    endRound();
  }

  updateScores();
  if (state.mode !== "easy" && !state.resolved) {
    const inp = document.getElementById("guessInput");
    if (inp) { inp.value=""; selectedGuess=null; }
    const btn = document.getElementById("submitBtn");
    if (btn) btn.disabled = true;
  }
}

function endRound() {
  state.resolved = true;
  document.getElementById("nextRow").style.display = "flex";

  if (state.mode === "easy") {
    document.querySelectorAll(".vtree-row").forEach(el => el.classList.add("disabled"));
    const ans = document.querySelector(`.vtree-row[data-key="${state.correctLCA}"]`);
    if (ans && !ans.classList.contains("guessed-correct")) {
      ans.classList.add("answer-reveal");
      ans.scrollIntoView({ behavior:"smooth", block:"center" });
    }
  } else {
    const inp = document.getElementById("guessInput");
    if (inp) inp.disabled = true;
    document.getElementById("treeReveal").className = "tree-reveal show";
    document.getElementById("treeSubtitle").textContent =
      `${state.sp1.emoji} ${state.sp1.name}  â†”  ${state.sp2.name} ${state.sp2.emoji}`;
    renderRevealTree(state.sp1, state.sp2, state.correctLCA);
  }
}

function skipRound() {
  if (state.resolved) return;
  state.streak = 0;
  document.getElementById("feedback").className = "feedback close-guess show";
  document.getElementById("fbTitle").textContent = "Skipped!";
  document.getElementById("fbText").textContent = `The answer was ${state.correctLCA} â€” ${ANCESTORS[state.correctLCA].desc}.`;
  updateScores();
  endRound();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER GUESS AREA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderGuessArea() {
  const wrap = document.getElementById("guessAreaWrap");

  if (state.mode === "easy") {
    wrap.innerHTML = `
      <div class="guess-label">Click the closest shared clade on the tree</div>
      <div class="vtree-wrap" id="vtreeWrap"></div>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="skipRound()">Skip</button>
      </div>`;
    renderVerticalTree();

  } else if (state.mode === "medium") {
    wrap.innerHTML = `
      <div class="guess-area">
        <div class="guess-label">What is their closest common clade?</div>
        <div class="guess-input-wrap">
          <input type="text" class="guess-input" id="guessInput" placeholder="Type a clade..." autocomplete="off">
          <div class="autocomplete" id="autocomplete"></div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="submitBtn" disabled onclick="onMediumSubmit()">Submit Guess</button>
        <button class="btn btn-secondary" onclick="skipRound()">Skip</button>
      </div>`;
    setupMediumMode();

  } else {
    wrap.innerHTML = `
      <div class="guess-area">
        <div class="guess-label">What is their closest common clade?</div>
        <div class="guess-input-wrap">
          <input type="text" class="guess-input" id="guessInput" placeholder="Type the exact clade name..." autocomplete="off">
        </div>
        <div class="no-match-msg" id="noMatch">No matching clade found. Check your spelling.</div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="submitBtn" onclick="onExpertSubmit()">Submit Guess</button>
        <button class="btn btn-secondary" onclick="skipRound()">Skip</button>
      </div>`;
    setupExpertMode();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EASY MODE: Vertical indented tree
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderVerticalTree() {
  const container = document.getElementById("vtreeWrap");

  function buildNode(key) {
    const children = getChildrenOf(key);
    const desc = ANCESTORS[key].desc;
    let childrenHtml = "";
    if (children.length > 0) {
      childrenHtml = `<div class="vtree-children">${children.map(c => buildNode(c)).join("")}</div>`;
    }
    return `<div class="vtree-node">
      <div class="vtree-row" data-key="${key}" onclick="onEasyClick('${key}')" title="${desc}">
        <span>${key}</span>
        <span class="vtree-desc">${desc}</span>
      </div>
      ${childrenHtml}
    </div>`;
  }

  container.innerHTML = buildNode("Metazoa");
}

function onEasyClick(key) {
  if (state.resolved) return;
  submitGuess(key);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEDIUM MODE: Autocomplete
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setupMediumMode() {
  const inp = document.getElementById("guessInput");
  const ac = document.getElementById("autocomplete");
  let acIdx = -1;
  selectedGuess = null;

  inp.addEventListener("input", () => {
    const val = inp.value.trim().toLowerCase();
    const matches = getMatchingClades(val);
    acIdx = -1; selectedGuess = null;
    document.getElementById("submitBtn").disabled = true;
    if (!val || matches.length===0) { ac.className="autocomplete"; ac.innerHTML=""; return; }
    ac.className = "autocomplete show";
    ac.innerHTML = matches.map((m,i) => `<div class="ac-item" data-key="${m.key}" data-index="${i}">
      <span class="ac-name">${m.key}</span><span class="ac-desc">${ANCESTORS[m.key].desc}</span>
    </div>`).join("");
    ac.querySelectorAll(".ac-item").forEach(el => {
      el.addEventListener("mousedown", e => { e.preventDefault(); selectAc(el.dataset.key, inp, ac); });
    });
  });

  inp.addEventListener("keydown", e => {
    const items = ac.querySelectorAll(".ac-item");
    if (e.key==="ArrowDown") { e.preventDefault(); acIdx=Math.min(acIdx+1,items.length-1); highlightAc(items,acIdx,inp,ac); }
    else if (e.key==="ArrowUp") { e.preventDefault(); acIdx=Math.max(acIdx-1,0); highlightAc(items,acIdx,inp,ac); }
    else if (e.key==="Enter") { e.preventDefault(); if(selectedGuess&&!state.resolved) submitGuess(selectedGuess); else if(acIdx>=0&&items[acIdx]) selectAc(items[acIdx].dataset.key,inp,ac); }
  });

  inp.addEventListener("blur", () => { setTimeout(()=>{ac.className="autocomplete";},150); });
  inp.focus();
}

function highlightAc(items, idx, inp, ac) {
  items.forEach((el,i) => el.classList.toggle("active",i===idx));
  if (idx>=0 && items[idx]) selectAc(items[idx].dataset.key, inp, ac);
}

function selectAc(key, inp, ac) {
  selectedGuess = key; inp.value = key; ac.className = "autocomplete";
  document.getElementById("submitBtn").disabled = false;
}

function onMediumSubmit() { if (selectedGuess && !state.resolved) submitGuess(selectedGuess); }

function getMatchingClades(q) {
  if (!q) return [];
  const matches = new Map();
  for (const [a,k] of Object.entries(ALIASES)) {
    if (a.includes(q) && !matches.has(k)) matches.set(k, { key:k, score:a.startsWith(q)?0:1 });
  }
  for (const [a,k] of Object.entries(EXTRA_ALIASES)) {
    if (a.toLowerCase().includes(q) && !matches.has(k)) matches.set(k, { key:k, score:a.toLowerCase().startsWith(q)?0:1 });
  }
  return [...matches.values()].sort((a,b)=>a.score-b.score||a.key.localeCompare(b.key)).slice(0,8);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPERT MODE: Free text, no hints
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setupExpertMode() {
  const inp = document.getElementById("guessInput");
  inp.addEventListener("keydown", e => { if(e.key==="Enter"){e.preventDefault();onExpertSubmit();} });
  inp.addEventListener("input", () => { document.getElementById("noMatch").classList.remove("show"); });
  inp.focus();
}

function onExpertSubmit() {
  if (state.resolved) return;
  const val = document.getElementById("guessInput").value.trim().toLowerCase();
  if (!val) return;
  const key = ALIASES[val] || EXTRA_ALIASES[val];
  if (key) { document.getElementById("noMatch").classList.remove("show"); submitGuess(key); }
  else { document.getElementById("noMatch").classList.add("show"); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REVEAL TREE (medium/expert post-round)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderRevealTree(sp1, sp2, lca) {
  const chain1 = getAncestorChain(sp1.clade);
  const chain2 = getAncestorChain(sp2.clade);

  const path1 = [sp1.name];
  for (const n of chain1) { path1.push(n); if(n===lca) break; }
  const path2 = [sp2.name];
  for (const n of chain2) { path2.push(n); if(n===lca) break; }

  const shared = [lca];
  for (const n of getAncestorChain(lca)) { if(n!==lca) shared.push(n); }

  const _c=document.createElement("canvas"), _ctx=_c.getContext("2d");
  function mT(s,f){_ctx.font=f;return _ctx.measureText(s).width;}
  const pX=28;
  function tW(s){return Math.max(mT(s,"700 12px 'DM Sans',sans-serif")+pX*2,80);}
  function dW(s){return mT(s,"400 9px 'DM Mono',monospace")+pX*2;}
  function nW(l,d){return Math.max(tW(l),d?dW(d):0);}
  const nHb=34,nHd=48,nG=10;
  function nH(d){return d?nHd:nHb;}

  function cYs(nodes,sy){const p=[];let y=sy;for(const n of nodes){const h=nH(!!n.desc);p.push({cy:y+h/2,h});y+=h+nG;}return p;}

  const sR=[...shared].reverse();
  const tN=sR.map(k=>({key:k,label:k,desc:ANCESTORS[k]?.desc||"",type:k===lca?"lca":"shared"}));
  const tY=cYs(tN,10);
  const lBot=tY[tY.length-1].cy+tY[tY.length-1].h/2;

  const b1=path1.slice(0,-1).reverse().map((k,i,a)=>{const s=i===a.length-1;return{key:k,label:s?`${sp1.emoji} ${k}`:k,desc:s?"":ANCESTORS[k]?.desc||"",type:s?"species":"branch"};});
  const b2=path2.slice(0,-1).reverse().map((k,i,a)=>{const s=i===a.length-1;return{key:k,label:s?`${sp2.emoji} ${k}`:k,desc:s?"":ANCESTORS[k]?.desc||"",type:s?"species":"branch"};});

  const b1Y=cYs(b1,lBot+nG), b2Y=cYs(b2,lBot+nG);

  const mW1=b1.length?Math.max(...b1.map(n=>nW(n.label,n.desc))):80;
  const mW2=b2.length?Math.max(...b2.map(n=>nW(n.label,n.desc))):80;
  const mTW=Math.max(...tN.map(n=>nW(n.label,n.desc)));

  const hG=50;
  const totW=Math.max(mW1+mW2+hG*2+40,mTW+40);
  const cX=totW/2, lX=cX-(hG+mW1/2), rX=cX+(hG+mW2/2);
  const botY=Math.max(b1Y.length?b1Y[b1Y.length-1].cy+b1Y[b1Y.length-1].h/2:lBot,b2Y.length?b2Y[b2Y.length-1].cy+b2Y[b2Y.length-1].h/2:lBot);
  const svgH=botY+20;

  let ls=[],ns=[];let ad=0;const ds=0.08;

  function aN(cx,cy,l,t,dl,dc){
    const hd=!!dc&&t!=="species";const w=nW(l,hd?dc:"");const h=nH(hd);
    let f,s,tf;
    if(t==="lca"){f="#22633d";s="#4ade80";tf="#4ade80";}
    else if(t==="species"){f="#0c4a6e";s="#38bdf8";tf="#38bdf8";}
    else if(t==="shared"){f="#1a2320";s="#2a3632";tf="#8a9b91";}
    else{f="#1a2320";s="#2a3632";tf="#e8ede9";}
    const dE=hd?`<text x="${cx}" y="${cy+10}" text-anchor="middle" font-family="'DM Mono',monospace" font-size="9" fill="#5a6e63">${dc}</text>`:"";
    ns.push(`<g class="tree-node-g" style="animation-delay:${dl.toFixed(2)}s"><rect x="${cx-w/2}" y="${cy-h/2}" width="${w}" height="${h}" rx="${h/2}" fill="${f}" stroke="${s}" stroke-width="1.5"/><text x="${cx}" y="${cy+(hd?-3:4)}" text-anchor="middle" font-family="'DM Sans',sans-serif" font-size="12" font-weight="${t==='lca'||t==='species'?'700':'500'}" fill="${tf}">${l}</text>${dE}</g>`);
  }
  function aL(x1,y1,x2,y2,dl,c){ls.push(`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${c||'#2a3632'}" stroke-width="2" class="tree-branch" style="animation-delay:${dl.toFixed(2)}s"/>`);}

  for(let i=0;i<tN.length;i++){const n=tN[i],{cy,h}=tY[i];aN(cX,cy,n.label,n.type,ad,n.desc);ad+=ds;if(i>0)aL(cX,tY[i-1].cy+tY[i-1].h/2,cX,cy-h/2,ad-ds*1.5,n.type==="lca"?"#22633d":"#2a3632");}
  const lcCy=tY[tY.length-1].cy,lcH=tY[tY.length-1].h;
  if(b1.length){aL(cX,lcCy+lcH/2,lX,b1Y[0].cy-b1Y[0].h/2,ad,"#22633d");ad+=ds;for(let i=0;i<b1.length;i++){aN(lX,b1Y[i].cy,b1[i].label,b1[i].type,ad,b1[i].desc);ad+=ds;if(i>0)aL(lX,b1Y[i-1].cy+b1Y[i-1].h/2,lX,b1Y[i].cy-b1Y[i].h/2,ad-ds*1.5);}}
  if(b2.length){aL(cX,lcCy+lcH/2,rX,b2Y[0].cy-b2Y[0].h/2,ad,"#22633d");ad+=ds;for(let i=0;i<b2.length;i++){aN(rX,b2Y[i].cy,b2[i].label,b2[i].type,ad,b2[i].desc);ad+=ds;if(i>0)aL(rX,b2Y[i-1].cy+b2Y[i-1].h/2,rX,b2Y[i].cy-b2Y[i].h/2,ad-ds*1.5);}}

  document.getElementById("treeSvgWrap").innerHTML=`<svg width="${totW}" height="${svgH}" viewBox="0 0 ${totW} ${svgH}" xmlns="http://www.w3.org/2000/svg">${ls.join("")}${ns.join("")}</svg>`;
}
</script>
</body>
</html>
